const line = require('@line/bot-sdk');

const config = {
  channelAccessToken: 'aqwnQE4I0de3KONts7fd1dhDlmiNBtSsQb1AOzCTsAOSKxxoEMK4JeU+9U0+dwi6uJIHA1/5tLXX4SoreEyyzCgTCzHfWe3ITyPgQkOwdQl3DjgRhRS5VEMDAtDdaxeC2SxO9xEK0et2xk4jWeqmtwdB04t89/1O/w1cDnyilFU='
};

const client = new line.Client(config);

exports.handler = async (event) => {
  try {
    const body = JSON.parse(event.body);

    // üîê ‡∏ñ‡πâ‡∏≤ events ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏á
    if (!body.events || !Array.isArray(body.events) || body.events.length === 0) {
      console.log('No events received');
      return {
        statusCode: 200,
        body: 'OK'
      };
    }

    const eventObj = body.events[0];

    if (eventObj.type === 'message' && eventObj.message.type === 'text') {
      const userMessage = eventObj.message.text;
      let replyText = '';

      // üîë ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      const cheapKeywords = ['‡∏≠‡∏∞‡πÑ‡∏£‡∏ñ‡∏π‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î', '‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡∏î', '‡∏ñ‡∏π‡∏Å', '‡∏≠‡∏∞‡πÑ‡∏£‡∏ñ‡∏π‡∏Å', '‡∏≠‡∏∞‡πÑ‡∏£‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡∏î'];
      const suggestKeywords = ['‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥', '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢', '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢', '‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á', '‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á'];
      const warrantyKeywords = ['‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', '‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏°', '‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á'];
      const shippingKeywords = ['‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á', '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á', '‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô', '‡∏™‡πà‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏á', '‡∏™‡πà‡∏á‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô'];
      const orderKeywords = ['‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', '‡∏™‡∏±‡πà‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏á', '‡∏ã‡∏∑‡πâ‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏á', '‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡∏±‡πà‡∏á', '‡∏ß‡∏¥‡∏ò‡∏µ‡∏ã‡∏∑‡πâ‡∏≠'];
      const helpKeywords = ['help', '‡∏ä‡πà‡∏ß‡∏¢', '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á', '‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á'];

      if (cheapKeywords.some(k => userMessage.includes(k))) {
        replyText = `iPad Air 11 ‡∏ô‡∏¥‡πâ‡∏ß ‡∏£‡∏≤‡∏Ñ‡∏≤ 23,990 ‡∏ö‡∏≤‡∏ó\n‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: https://bit.ly/4kzDhYc`;
      } else if (suggestKeywords.some(k => userMessage.includes(k))) {
        replyText = `‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö:\n\nüì± iPhone 15 ‚Äì 29,900 ‡∏ö‡∏≤‡∏ó\nhttps://bit.ly/4kcfHBe\n\nüì± iPhone 16 ‚Äì 39,900 ‡∏ö‡∏≤‡∏ó\nhttps://bit.ly/3FpKsU3\n\nüì± iPad Air 11 ‡∏ô‡∏¥‡πâ‡∏ß ‚Äì 23,990 ‡∏ö‡∏≤‡∏ó\nhttps://bit.ly/4kzDhYc`;
      } else if (warrantyKeywords.some(k => userMessage.includes(k))) {
        replyText = `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå Apple 1 ‡∏õ‡∏µ‡πÄ‡∏ï‡πá‡∏°\n‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö`;
      } else if (shippingKeywords.some(k => userMessage.includes(k))) {
        replyText = `‡πÄ‡∏£‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô Kerry ‡∏´‡∏£‡∏∑‡∏≠ Flash Express ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1-2 ‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö`;
      } else if (orderKeywords.some(k => userMessage.includes(k))) {
        replyText = `‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ä‡∏ó‡∏Å‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏±‡∏ö\n‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠: https://bit.ly/order-contact`;
      } else if (helpKeywords.some(k => userMessage.toLowerCase().includes(k))) {
        replyText = `‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ:\n- ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n- ‡∏≠‡∏∞‡πÑ‡∏£‡∏ñ‡∏π‡∏Å‡∏™‡∏∏‡∏î\n- ‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô\n- ‡∏™‡πà‡∏á‡∏Ç‡∏≠‡∏á\n- ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠`;
      } else {
        replyText = `‡∏Ç‡∏≠‡πÇ‡∏ó‡∏©‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°\n‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤ "help" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö`;
      }

      await client.replyMessage(eventObj.replyToken, {
        type: 'text',
        text: replyText
      });
    }

    // ‚úÖ ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö LINE Platform ‡πÄ‡∏™‡∏°‡∏≠
    return {
      statusCode: 200,
      body: 'OK'
    };

  } catch (err) {
    console.error('Error:', err);
    return {
      statusCode: 500,
      body: 'Internal Server Error'
    };
  }
};
